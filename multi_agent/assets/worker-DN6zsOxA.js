(function(){"use strict";let s,i,_,T=[];self.onmessage=async r=>{const{type:e,payload:t}=r.data;e==="init"?await l(t):e==="run"&&await d(t)};async function l({buffer:r}){i=new Int32Array(r),_=new Uint8Array(r);const{loadPyodide:e}=await import("https://cdn.jsdelivr.net/pyodide/v0.26.0/full/pyodide.mjs");s=await e({indexURL:"https://cdn.jsdelivr.net/pyodide/v0.26.0/full/",fullStdLib:!0,stdout:t=>{T.push(t),self.postMessage({type:"stdout",text:t})},stderr:t=>self.postMessage({type:"stderr",text:t})}),S(),self.postMessage({type:"ready"})}function c(r,e,t,o){const n=new TextEncoder,a=n.encode(e);if(_.set(a,16),_[16+a.length]=0,console.log(`Send new op: ${r}
RawPath: ${a}
Path: ${e}`),r===11&&ArrayBuffer.isView(t))_.set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength),16+a.length+1),Atomics.store(i,2,t.byteLength),Atomics.store(i,3,o||0);else if(r===8&&typeof t=="string"){const A=n.encode(t);_.set(A,16+a.length+1),Atomics.store(i,2,A.length)}else r===10?(Atomics.store(i,2,t),Atomics.store(i,3,o||0)):r===12&&Atomics.store(i,3,t);if(Atomics.store(i,1,r),Atomics.store(i,0,1),self.postMessage({type:"fs_req"}),Atomics.wait(i,0,1),Atomics.load(i,0)===3)throw new s.FS.ErrnoError(Atomics.load(i,2)||5);return{arg1:Atomics.load(i,2),arg2:Atomics.load(i,3)}}function S(){const r={mount:()=>r.createNode(null,"/",16895,0),createNode:(e,t,o,n)=>{const a=s.FS.createNode(e,t,o,n);return a.node_ops=r.node_ops,a.stream_ops=r.stream_ops,a},node_ops:{getattr:e=>{const t=c(1,s.FS.getPath(e));return{dev:1,ino:e.id||1,mode:t.arg1,nlink:1,uid:0,gid:0,rdev:0,size:t.arg2,atime:new Date,mtime:new Date,ctime:new Date,blksize:4096,blocks:Math.ceil(t.arg2/4096)}},setattr:(e,t)=>{t.size!==void 0&&c(12,s.FS.getPath(e),t.size)},lookup:(e,t)=>{const o=s.FS.getPath(e)+(s.FS.getPath(e)==="/"?"":"/")+t,n=c(1,o);return r.createNode(e,t,n.arg1,0)},readdir:e=>{c(2,s.FS.getPath(e));const t=Atomics.load(i,2);return[".","..",...new TextDecoder().decode(_.slice(16,16+t)).split(`
`).filter(n=>n)]},mknod:(e,t,o,n)=>{const a=r.createNode(e,t,o,n);return s.FS.isDir(o)?c(6,s.FS.getPath(a)):c(11,s.FS.getPath(a),new Uint8Array(0),0),a},rename:(e,t,o)=>c(8,s.FS.getPath(e),s.FS.getPath(t)+(s.FS.getPath(t)==="/"?"":"/")+o),unlink:(e,t)=>c(5,s.FS.getPath(e)+(s.FS.getPath(e)==="/"?"":"/")+t),rmdir:(e,t)=>c(7,s.FS.getPath(e)+(s.FS.getPath(e)==="/"?"":"/")+t)},stream_ops:{read:(e,t,o,n,a)=>{const A=c(10,s.FS.getPath(e.node),n,a);return t.set(_.subarray(16,16+A.arg1),o),A.arg1},write:(e,t,o,n,a)=>(c(11,s.FS.getPath(e.node),t.subarray(o,o+n),a),n),truncate:(e,t)=>{c(12,s.FS.getPath(e.node),t)},llseek:(e,t,o)=>{let n=t;if(o===1?n+=e.position:o===2&&(n+=c(1,s.FS.getPath(e.node)).arg2),n<0)throw new s.FS.ErrnoError(28);return n}}};s.FS.mkdir("/workspace"),s.FS.mount(r,{},"/workspace"),s.runPython("import os; os.chdir('/workspace'); import sys; sys.path.append('/workspace')")}async function d({code:r,id:e}){try{T=[],await s.loadPackagesFromImports(r);const t=await s.runPythonAsync(r);let o=t&&typeof t.toJs=="function"?t.toJs({dict_converter:Object.fromEntries,create_proxies:!1}):t;t&&t.destroy&&t.destroy(),self.postMessage({type:"result",id:e,result:{console_output:T.join(""),result:o}})}catch(t){self.postMessage({type:"error",id:e,error:{console_output:T.join(""),message:t.message}})}}})();
